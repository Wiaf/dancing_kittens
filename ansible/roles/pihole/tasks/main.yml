---

- stat:
    path: /usr/local/bin/pihole
  register: pihole_binary

- set_fact:
    pihole_installed: "{{ pihole_binary.stat.exists | default(false) }}"

- name: create pihole directory
  file:
    path: /etc/pihole
    state: directory

- name: copy pihole conf
  copy:
    src: pihole-setupVars.conf
    dest: /etc/pihole/setupVars.conf
  register: pihole_config
  notify:
    - restart dhcpcd

- name: download install script
  block:
    - name:
      get_url:
        url: https://raw.githubusercontent.com/pi-hole/pi-hole/master/automated%20install/basic-install.sh
        dest: ~/pihole-install.sh
        mode: u+rwx

    - name: run install script
      shell: ~/pihole-install.sh --unattended
  when: not pihole_installed

## list scripts
- name: install required packages
  apt:
    name:
      - php{{ php_version }}-common
      - php{{ php_version }}-cli
      - php{{ php_version }}-sqlite3
      - php{{ php_version }}-intl
      - php{{ php_version }}-curl
    state: present
    install_recommends: yes


- name: clone from addlist_config
  block:
    - name: clone config scripts
      git:
       repo: git@github.com:jacklul/pihole-updatelists.git
       dest: /tmp/{{ pihole_temp }}/

    - name: run installer
      shell:
       cmd: screen sudo pihole-updatelists
       chdir: /usr/local/bin
  when: not pihole_installed
